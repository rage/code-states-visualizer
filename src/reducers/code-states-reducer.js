// @flow
import { createReducer } from 'redux-create-reducer';
import { CODE_STATE_CHANGED } from 'state/actions';
import type { CodeStateAction } from 'state/actions';

export type State = {
  code: string,
  code_states: [],
  index: number,
  current_stack: [],
  current_print_outputs: [],
}

/* eslint-disable max-len */
const tempCode = 'public class YourClassNameHere {\n    public static void main(String[] args) {\n      int numero = 2;\n\t      int monesti = 3;\n\t      \n\t      for (int i = 0; i < monesti; i++) {\n\t         numero = squared(numero);\n\t         System.out.println(\"Numero on nyt \" + numero);\n\t      }\n    }\n    \n    public static int squared(int alkuperainen) {\n\t      int palautettava = alkuperainen * alkuperainen;\n\t      return palautettava;\n\t   }\n}';

const tempStates = JSON.parse('[{"stdout":"","event":"call","line":3,"stack_to_render":[{"func_name":"main:3","encoded_locals":{},"ordered_varnames":[],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"1","frame_id":1}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"step_line","line":3,"stack_to_render":[{"func_name":"main:3","encoded_locals":{},"ordered_varnames":[],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"2","frame_id":2}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"step_line","line":4,"stack_to_render":[{"func_name":"main:4","encoded_locals":{"numero":2},"ordered_varnames":["numero"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"4","frame_id":4}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"numero":2,"monesti":3},"ordered_varnames":["numero","monesti"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"7","frame_id":7}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"10","frame_id":10}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"step_line","line":7,"stack_to_render":[{"func_name":"main:7","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"13","frame_id":13}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"call","line":13,"stack_to_render":[{"func_name":"squared:13","encoded_locals":{"alkuperainen":2},"ordered_varnames":["alkuperainen"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"16","frame_id":16},{"func_name":"main:7","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"17","frame_id":17}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"","event":"step_line","line":13,"stack_to_render":[{"func_name":"squared:13","encoded_locals":{"alkuperainen":2},"ordered_varnames":["alkuperainen"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"18","frame_id":18},{"func_name":"main:7","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"19","frame_id":19}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"","event":"step_line","line":14,"stack_to_render":[{"func_name":"squared:14","encoded_locals":{"alkuperainen":2,"palautettava":4},"ordered_varnames":["alkuperainen","palautettava"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"28","frame_id":28},{"func_name":"main:7","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"29","frame_id":29}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"","event":"return","line":14,"stack_to_render":[{"func_name":"squared:14","encoded_locals":{"alkuperainen":2,"palautettava":4,"__return__":4},"ordered_varnames":["alkuperainen","palautettava","__return__"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"34","frame_id":34},{"func_name":"main:7","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"35","frame_id":35}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"","event":"step_line","line":7,"stack_to_render":[{"func_name":"main:7","encoded_locals":{"i":0,"numero":2,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"36","frame_id":36}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"","event":"step_line","line":8,"stack_to_render":[{"func_name":"main:8","encoded_locals":{"i":0,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"37","frame_id":37}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":0,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"40","frame_id":40}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"41","frame_id":41}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":7,"stack_to_render":[{"func_name":"main:7","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"45","frame_id":45}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"call","line":13,"stack_to_render":[{"func_name":"squared:13","encoded_locals":{"alkuperainen":4},"ordered_varnames":["alkuperainen"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"48","frame_id":48},{"func_name":"main:7","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"49","frame_id":49}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":13,"stack_to_render":[{"func_name":"squared:13","encoded_locals":{"alkuperainen":4},"ordered_varnames":["alkuperainen"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"50","frame_id":50},{"func_name":"main:7","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"51","frame_id":51}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":14,"stack_to_render":[{"func_name":"squared:14","encoded_locals":{"alkuperainen":4,"palautettava":16},"ordered_varnames":["alkuperainen","palautettava"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"60","frame_id":60},{"func_name":"main:7","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"61","frame_id":61}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"return","line":14,"stack_to_render":[{"func_name":"squared:14","encoded_locals":{"alkuperainen":4,"palautettava":16,"__return__":16},"ordered_varnames":["alkuperainen","palautettava","__return__"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"66","frame_id":66},{"func_name":"main:7","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"67","frame_id":67}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":7,"stack_to_render":[{"func_name":"main:7","encoded_locals":{"i":1,"numero":4,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"68","frame_id":68}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\n","event":"step_line","line":8,"stack_to_render":[{"func_name":"main:8","encoded_locals":{"i":1,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"69","frame_id":69}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":1,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"74","frame_id":74}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"75","frame_id":75}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":7,"stack_to_render":[{"func_name":"main:7","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"79","frame_id":79}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"call","line":13,"stack_to_render":[{"func_name":"squared:13","encoded_locals":{"alkuperainen":16},"ordered_varnames":["alkuperainen"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"82","frame_id":82},{"func_name":"main:7","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"83","frame_id":83}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":13,"stack_to_render":[{"func_name":"squared:13","encoded_locals":{"alkuperainen":16},"ordered_varnames":["alkuperainen"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"84","frame_id":84},{"func_name":"main:7","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"85","frame_id":85}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":14,"stack_to_render":[{"func_name":"squared:14","encoded_locals":{"alkuperainen":16,"palautettava":256},"ordered_varnames":["alkuperainen","palautettava"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"94","frame_id":94},{"func_name":"main:7","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"95","frame_id":95}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"return","line":14,"stack_to_render":[{"func_name":"squared:14","encoded_locals":{"alkuperainen":16,"palautettava":256,"__return__":256},"ordered_varnames":["alkuperainen","palautettava","__return__"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"100","frame_id":100},{"func_name":"main:7","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":false,"is_zombie":false,"is_parent":false,"unique_hash":"101","frame_id":101}],"globals":{},"ordered_globals":[],"func_name":"squared","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":7,"stack_to_render":[{"func_name":"main:7","encoded_locals":{"i":2,"numero":16,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"102","frame_id":102}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\n","event":"step_line","line":8,"stack_to_render":[{"func_name":"main:8","encoded_locals":{"i":2,"numero":256,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"103","frame_id":103}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\nNumero on nyt 256\\n","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":2,"numero":256,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"108","frame_id":108}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\nNumero on nyt 256\\n","event":"step_line","line":6,"stack_to_render":[{"func_name":"main:6","encoded_locals":{"i":3,"numero":256,"monesti":3},"ordered_varnames":["numero","monesti","i"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"109","frame_id":109}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\nNumero on nyt 256\\n","event":"step_line","line":10,"stack_to_render":[{"func_name":"main:10","encoded_locals":{"numero":256,"monesti":3},"ordered_varnames":["numero","monesti"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"113","frame_id":113}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}},{"stdout":"Numero on nyt 4\\nNumero on nyt 16\\nNumero on nyt 256\\n","event":"return","line":10,"stack_to_render":[{"func_name":"main:10","encoded_locals":{"numero":256,"monesti":3,"__return__":["VOID"]},"ordered_varnames":["numero","monesti","__return__"],"parent_frame_id_list":[],"is_highlighted":true,"is_zombie":false,"is_parent":false,"unique_hash":"115","frame_id":115}],"globals":{},"ordered_globals":[],"func_name":"main","heap":{}}]').slice(1);
/* eslint-enable max-len */

function normalizeStack(stack) {
  const modifiedStack = [];
  stack.forEach((sf) => {
    const toModifiedStack = {};
    toModifiedStack.func_name = sf.func_name;
    toModifiedStack.is_highlighted = sf.is_highlighted;
    const modifiedLocals = [];
    sf.ordered_varnames.forEach((name) => {
      const key = name;
      const value = sf.encoded_locals[name];
      if (key === '__return__') {
        if (Array.isArray(value)) {
          modifiedLocals.push(['return value', value[0]]);
        } else {
          modifiedLocals.push(['return value', value]);
        }
      } else {
        modifiedLocals.push([key, JSON.stringify(value)]);
      }
    });
    toModifiedStack.encoded_locals = modifiedLocals;
    modifiedStack.unshift(toModifiedStack);
  });
  return modifiedStack;
}

function fixNewLines(outputs) {
  return outputs.split('\n');
}

const initialState = {
  code: tempCode,
  code_states: tempStates,
  index: 0,
  current_stack: normalizeStack(tempStates[0].stack_to_render),
  current_print_outputs: fixNewLines(tempStates[0].stdout),
};

export default createReducer(initialState, {
  [CODE_STATE_CHANGED](state: State, action: CodeStateAction): State {
    return {
      ...state,
      ...{
        index: action.index,
        current_stack: normalizeStack(tempStates[action.index].stack_to_render),
        current_print_outputs: fixNewLines(tempStates[action.index].stdout),
      },
    };
  },
});
